{% extends "base.html" %}
{% block title %}View Credentials{% endblock %}

{% block content %}
<style>
  .folder-card {
    background: rgba(255, 255, 255, 0.07);
    border-radius: 12px;
    backdrop-filter: blur(8px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    transition: transform 0.3s ease, background-color 0.3s ease;
    padding: 15px;
    cursor: pointer;
    color: #f0f2f5;
    margin-bottom: 15px;
  }

  .folder-card:hover {
    transform: translateY(-5px);
    background: rgba(255, 255, 255, 0.1);
  }

  .folder-icon {
    font-size: 2rem;
    color: #74c0fc;
    margin-bottom: 10px;
  }

  .folder-name {
    font-weight: 600;
    font-size: 1.05rem;
    word-wrap: break-word;
  }

  .folder-details {
    font-size: 0.9rem;
    color: #ced4da;
  }
</style>

<div class="container mt-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="fw-bold">
      <i class="bi bi-folder-fill me-2"></i>{{ current_folder.name if current_folder else 'Root' }}
    </h3>
    <div class="d-flex gap-2">
      {% if is_owner %}
        <a href="{{ url_for('credentials') }}?folder_id={{ current_folder.id if current_folder else '' }}" class="btn btn-success btn-sm">
          <i class="bi bi-key-fill me-1"></i> Add Credential
        </a>
        <a href="{{ url_for('folders') }}?parent_id={{ current_folder.id if current_folder else '' }}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-folder-plus me-1"></i> Add Subfolder
        </a>
      {% endif %}
    </div>
  </div>

  {% if current_folder and current_folder.parent_id %}
    <a href="{{ url_for('view', folder_id=current_folder.parent_id) }}" class="btn btn-link px-0">
      <i class="bi bi-arrow-left-circle"></i> Back
    </a>
  {% elif current_folder %}
    <a href="{{ url_for('view') }}" class="btn btn-link px-0">
      <i class="bi bi-house-door-fill"></i> Back to Root
    </a>
  {% endif %}

  <hr>

<h5 class="fw-semibold mt-4"><i class="bi bi-folder2-open me-1"></i>Subfolders</h5>
{% if subfolders %}
<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-3 mb-4">
  {% for folder in subfolders %}
    <div class="col">
      
      <a href="{{ url_for('view', folder_id=folder.id) }}" class="text-decoration-none text-dark">
        <div class="card h-100 shadow-sm border-0">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-folder-fill text-warning me-2 fs-4"></i>
            <h6 class="mb-0 text-truncate">{{ folder.name }}</h6>
          </div>
        </div>
      </a>
    </div>
  {% endfor %}
</div>
{% else %}
  <div class="alert alert-secondary">No subfolders found.</div>
{% endif %}

{% if credentials %}
<h5 class="fw-semibold mb-3"><i class="bi bi-shield-lock-fill me-1"></i>Credentials</h5>
<div class="table-responsive">
  <table class="table table-hover align-middle">
    <thead class="table-light">
      <tr>
        <th><i class="bi bi-person-badge-fill"></i> Name</th>
        <th><i class="bi bi-link-45deg"></i> URL</th>
        <th><i class="bi bi-person-lines-fill"></i> Username</th>
        <th><i class="bi bi-eye-slash-fill"></i> Password</th>
        <th><i class="bi bi-chat-left-text-fill"></i> Notes</th>
        <th class="text-end"><i class="bi bi-gear-fill"></i> Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for cred in credentials %}
      <tr>
        <td>{{ cred.name }}</td>
        <td>
          {% if cred.url %}
            {% set url_stripped = cred.url | replace('https://', '') | replace('http://', '') %}
            {% set domain = url_stripped.partition('/')[0] %}
            <img src="https://www.google.com/s2/favicons?sz=16&domain={{ domain }}" alt="favicon" class="me-1" />
            <a href="{{ cred.url }}" target="_blank" class="text-decoration-none">
              {{ domain }}
            </a>
          {% else %}
            â€”
          {% endif %}
        </td>
        <td>{{ cred.username or "â€”" }}</td>
        <td>
          <span id="pw_{{ cred.id }}">â€¢â€¢â€¢â€¢â€¢â€¢</span>
          <input type="hidden" id="raw_{{ cred.id }}" value="{{ cred.decrypted_password }}">
          <button class="btn btn-outline-secondary btn-sm ms-2" id="copyBtn_{{ cred.id }}" onclick="copyPassword('{{ cred.id }}')">
            <i class="bi bi-clipboard"></i>
          </button>
          <button class="btn btn-outline-secondary btn-sm ms-2" onclick="togglePassword('{{ cred.id }}')">
            <i class="bi bi-eye"></i>
          </button>
        </td>
       <td style="max-width: 300px;">
  {% if cred.notes %}
    <div class="note-preview">
      <span class="short-text">{{ cred.notes[:100] }}...</span>
      <span class="full-text d-none">{{ cred.notes }}</span>
      <a href="#" class="toggle-note small">Show more</a>
    </div>
  {% else %}
    â€”
  {% endif %}
</td>

<td class="text-end">
  {% if is_owner %}
    <div class="d-flex justify-content-end align-items-center gap-2">
      <!-- Edit Button -->
      <a href="{{ url_for('credentials', edit_cred=cred.id) }}" class="btn btn-sm btn-warning">
        <i class="bi bi-pencil-fill"></i>
      </a>

      <!-- Delete Button triggers modal -->
      <button class="btn btn-sm btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ cred.id }}">
        <i class="bi bi-trash-fill"></i>
      </button>
    </div>

    <!-- Delete Modal -->
    <div class="modal fade" id="deleteModal{{ cred.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ cred.id }}" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow">
          <div class="modal-header bg-danger text-white">
            <h5 class="modal-title" id="deleteModalLabel{{ cred.id }}">Confirm Deletion</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete  <strong>{{ cred.name }}</strong>?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <a href="{{ url_for('delete_cred', id=cred.id) }}" class="btn btn-danger">Yes, Delete</a>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <span class="text-muted">ðŸ”’ View Only</span>
  {% endif %}
</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

{% else %}
  <div class="alert alert-secondary mt-4">No credentials in this folder.</div>
{% endif %}

<script>
 function togglePassword(id) {
    const target = document.getElementById("pw_" + id);
    const raw = document.getElementById("raw_" + id);
    target.innerText = target.innerText === 'â€¢â€¢â€¢â€¢â€¢â€¢' ? raw.value : 'â€¢â€¢â€¢â€¢â€¢â€¢';
  }

  function copyPassword(id) {
    const raw = document.getElementById("raw_" + id).value;
    const btn = document.getElementById("copyBtn_" + id);
    navigator.clipboard.writeText(raw).then(() => {
      btn.innerHTML = '<i class="bi bi-clipboard-check text-success"></i>';
      setTimeout(() => {
        btn.innerHTML = '<i class="bi bi-clipboard"></i>';
      }, 2000);
    });
  }




  document.querySelectorAll('.toggle-note').forEach(link => {
    link.addEventListener('click', function (e) {
      e.preventDefault();
      const parent = this.closest('.note-preview');
      parent.querySelector('.short-text').classList.toggle('d-none');
      parent.querySelector('.full-text').classList.toggle('d-none');
      this.textContent = this.textContent === 'Show more' ? 'Show less' : 'Show more';
    });
  });
</script>

{% endblock %}
