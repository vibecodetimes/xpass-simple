{% extends "base.html" %}
{% block title %}Manage Users{% endblock %}

{% block content %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@tabler/core@latest/dist/css/tabler.min.css" rel="stylesheet">

<div class="container py-4">
  <h2 class="fw-bold mb-4"><i class="bi bi-speedometer2"></i> Admin Dashboard</h2>

  <!-- Stats Cards -->
  <div class="row g-3 mb-4">
    {% set stats = [
      {'label': 'Total Users', 'count': total_users, 'icon': 'people', 'color': '#0d6efd'},
      {'label': 'Credentials', 'count': total_creds, 'icon': 'key', 'color': '#198754'},
      {'label': 'Folders', 'count': total_folders, 'icon': 'folder', 'color': '#0086FF'},
      {'label': 'Admins', 'count': admin_count, 'icon': 'shield-lock', 'color': '#343a40'},
      
    ] %}
    {% for stat in stats %}
    <div class="col-sm-6 col-md-3">
      <div class="card card-sm text-white shadow-sm" style="background-color: {{ stat.color }};">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <div class="fs-5 fw-bold">{{ stat.count }}</div>
            <small>{{ stat.label }}</small>
          </div>
          <i class="bi bi-{{ stat.icon }} fs-3"></i>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <!-- Login Activity -->
  <div class="card shadow-sm mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0"><i class="bi bi-activity"></i> Recent Login Activity</h5>
    <button type="button" class="btn btn-sm btn-outline-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#loginActivityCollapse" aria-expanded="false">
      <i class="bi bi-chevron-down"></i>
    </button>
  </div>
  <div class="collapse p-3" id="loginActivityCollapse">
    <div class="table-responsive">
      <table class="table table-sm table-hover mb-0">
        <thead class="table-light">
          <tr>
            <th>User</th>
            <th>IP Address</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody>
          {% for log in login_logs %}
          <tr>
            <td>{{ log.user.username }}</td>
            <td>{{ log.ip_address }}</td>
            <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- User Management -->
  <div class="card shadow-sm mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0"><i class="bi bi-person"></i> User Management</h5>
      <button class="btn btn-sm btn-outline-secondary toggle-btn" data-bs-toggle="collapse" data-bs-target="#userTableCollapse" aria-expanded="false">
        <i class="bi bi-chevron-down"></i>
      </button>
    </div>
    <div class="collapse p-0" id="userTableCollapse">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 mb-4">
          <button class="btn btn-dark btn-sm" onclick="showAddUserModal()">
            <i class="bi bi-person-plus text-success "></i>  Add User
          </button>
          <button class="btn btn-dark btn-sm" onclick="showEditUserModal()">
            <i class="bi bi-pencil-square text-primary"></i>  Edit User
          </button>
          <button class="btn btn-dark btn-sm" onclick="showResetPasswordModal()">
            <i class="bi bi-key text-warning "></i>  Reset Password
          </button>
          <button class="btn btn-dark btn-sm" onclick="showDeleteUserModal()">
            <i class="bi bi-trash text-danger "></i>  Delete User
          </button>
          <button class="btn btn-dark btn-sm" onclick="showReset2faModal()">
            <i class="bi bi-shield-slash text-info "></i>  Reset 2FA
          </button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-sm align-middle">
            <thead class="table-light">
              <tr>
                <th>Select</th>
                <th>Username</th>
                <th>Email</th>
                <th>Role</th>
                <th class="text-center">2FA</th>
              </tr>
            </thead>
            <tbody>
              {% for user in users %}
              <tr>
                <td>
                  <input type="radio" name="selected_user" value="{{ user.id }}"
                         onclick="selectUser('{{ user.id }}', '{{ user.username }}', '{{ user.email }}', '{{ user.role }}')">
                </td>
                <td>{{ user.username }}</td>
                <td>{{ user.email }}</td>
                <td class="text-capitalize">{{ user.role }}</td>
                <td class="text-center">
                  {% if user.twofa_enabled %}
                    <span class="badge rounded-pill bg-dark px-2 py-1 text-success">
                      <i class="bi bi-shield-lock-fill me-1"></i> Enabled
                    </span>
                  {% else %}
                    <span class="badge rounded-pill bg-dark px-2 py-1 text-danger">
                      <i class="bi bi-shield-slash me-1"></i> Disabled
                    </span>
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


<div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #030444, #073c5f);">
  <div class="card-body text-center">
    <div class="mb-3">
      <i class="bi bi-cloud-upload-fill text-info fs-1"></i>
    </div>
    <h5 class="fw-bold mb-2">Need Import & Signup Functionality?</h5>
    <p class="text-white mb-3">
      Save time with bulk user import or allow employees to sign up themselves — available as a one-time paid upgrade.
    </p>
    <div class="fw-semibold text-white mb-3">
      Just <span class="text-success ">$5</span> — one-time add-on.
    </div>
    <a href="mailto:contact@vibecodetimes.com?subject=Enable%20Signup%20Feature" class="btn btn-success text-dark btn-sm rounded-pill px-4">
      <i class="bi bi-envelope-fill me-1"></i> Contact Us to Enable
    </a>
  </div>
</div>






<!-- Add user Modal  -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="/admin/users" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="mb-3"><label class="form-label">Username</label><input name="username" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Email</label><input name="email" type="email" class="form-control" required></div>
        <div class="mb-3"><label class="form-label">Role</label>
          <select name="role" class="form-select">
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
        <div class="mb-3"><label class="form-label">Password</label><input name="password" type="password" class="form-control" required></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add User</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit User Modal (fixed with correct action) -->
<div class="modal fade" id="editUserModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" action="/admin/edit_user" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="user_id" id="editUserId">
        <div class="mb-3">
          <label class="form-label">Username</label>
          <input name="username" id="editUsername" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Email</label>
          <input type="email" name="email" id="editEmail" class="form-control" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Role</label>
          <select name="role" id="editRole" class="form-select">
            <option value="admin">Admin</option>
            <option value="user">User</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</div>
<!-- PW reset -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" id="resetPasswordForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset Password</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <p>Reset password for <strong id="resetPasswordUsername"></strong>:</p>
        <div class="mb-3">
          <label class="form-label">New Password</label>
          <input type="password" name="new_password" class="form-control" required>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-warning">Reset</button>
      </div>
    </form>
  </div>
</div>

<!-- Delete User Modal (fixed to match route with ID) -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" id="deleteUserForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <p>Are you sure you want to delete <strong id="deleteUsername"></strong>?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-danger">Delete</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="reset2faModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" id="reset2faForm" class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Reset 2FA</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <p>Reset 2FA for <strong id="reset2faUsername"></strong>?</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-info text-white">Reset 2FA</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let selectedUser = null;

function selectUser(id, username, email, role) {
  selectedUser = { id, username, email, role };
}

function showAddUserModal() {
  new bootstrap.Modal(document.getElementById('addUserModal')).show();
}

function showEditUserModal() {
  if (!selectedUser) return alert("Select a user first.");
  document.getElementById('editUserId').value = selectedUser.id;
  document.getElementById('editUsername').value = selectedUser.username;
  document.getElementById('editEmail').value = selectedUser.email;
  document.getElementById('editRole').value = selectedUser.role;
  new bootstrap.Modal(document.getElementById('editUserModal')).show();
}

function showResetPasswordModal() {
  if (!selectedUser) return alert("Select a user first.");
  document.getElementById('resetPasswordForm').action = `/admin/reset_password/${selectedUser.id}`;
  document.getElementById('resetPasswordUsername').textContent = selectedUser.username;
  new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

function showDeleteUserModal() {
  if (!selectedUser) return alert("Select a user first.");
  document.getElementById('deleteUserForm').action = `/admin/delete_user/${selectedUser.id}`;
  document.getElementById('deleteUsername').textContent = selectedUser.username;
  new bootstrap.Modal(document.getElementById('deleteUserModal')).show();
}

function showReset2faModal() {
  if (!selectedUser) return alert("Select a user first.");
  document.getElementById('reset2faForm').action = `/admin/reset_2fa/${selectedUser.id}`;
  document.getElementById('reset2faUsername').textContent = selectedUser.username;
  new bootstrap.Modal(document.getElementById('reset2faModal')).show();
}

// Unified toggle behavior for chevron icons and padding



</script>

{% endblock %}
